<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>智能文件撰写系统</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        body {
            font-family: 'SF Pro Display', 'Helvetica Neue', Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #f5f5f7;
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 48px auto 0 auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.08);
            padding: 36px 32px 32px 32px;
        }
        h2 {
            text-align: center;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 32px;
        }
        .form-flex {
            display: flex;
            gap: 48px;
        }
        .form-section {
            flex: 1 1 400px;
            min-width: 350px;
        }
        .form-group {
            margin-bottom: 22px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
        }
        input[type="file"] {
            margin-top: 8px;
        }
        select, input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 15px;
        }
        button[type="submit"] {
            width: 100%;
            background: #007aff;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);
            transition: background 0.2s;
        }
        button[type="submit"]:hover {
            background: #005ecb;
        }
        .error {
            color: #d93025;
            margin-bottom: 16px;
            text-align: center;
        }
        .stream-result {
            background: #fafbfc;
            border-radius: 14px;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);
            padding: 20px 18px 18px 18px;
            min-height: 180px;
            margin-top: 24px;
            font-size: 16px;
            color: #222;
            white-space: pre-wrap;
            word-break: break-all;
        }
        @media (max-width: 900px) {
            .container { max-width: 98vw; padding: 18px 4vw 18px 4vw; }
            .form-flex { flex-direction: column; gap: 16px; }
        }
    </style>
    <script>
        function updateFormDisplay() {
            // 改写
            var ifRewriter = document.getElementById('if_rewriter').value;
            document.getElementById('origin_article_group').style.display = (ifRewriter === '是') ? 'block' : 'none';
            // 仿写
            var ifImitate = document.getElementById('if_imitate_writing').value;
            document.getElementById('imitate_article_group').style.display = (ifImitate === '是') ? 'block' : 'none';
            // 数据库
            var ifDb = document.getElementById('if_database').value;
            document.getElementById('keyword_database_group').style.display = (ifDb === '是') ? 'block' : 'none';
            // 联网
            var ifOnline = document.getElementById('if_online_search').value;
            document.getElementById('online_search_topic_group').style.display = (ifOnline === '是') ? 'block' : 'none';
        }
        function showError(msg) {
            document.getElementById('error_box').innerText = msg;
        }
        function clearError() {
            document.getElementById('error_box').innerText = '';
        }
        function clearResult() {
            document.getElementById('stream_result').innerText = '';
        }
        async function handleFormSubmit(e) {
            e.preventDefault();
            clearError();
            clearResult();
            document.getElementById('stream_result').innerText = '生成中……';
            const form = e.target;
            const formData = new FormData(form);
            try {
                // 1. 先POST /upload，获取inputs和user_id、sys_query
                const resp = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                if (!resp.ok) {
                    showError('文件上传失败');
                    return;
                }
                const data = await resp.json();
                if (!data.inputs || !data.user_id || !data.sys_query) {
                    showError('参数返回异常');
                    return;
                }
                // 2. POST /stream_chat，流式获取AI输出
                const streamResp = await fetch('/stream_chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputs: data.inputs, user_id: data.user_id, sys_query: data.sys_query })
                });
                if (!streamResp.ok) {
                    showError('AI流式接口调用失败');
                    return;
                }
                const reader = streamResp.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                let result = '';
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split(/\n\n/);
                    buffer = lines.pop();
                    for (let line of lines) {
                        if (line.startsWith('data:')) {
                            let content = line.slice(5).trim();
                            if (content.startsWith('[ERROR]')) {
                                showError(content);
                            } else {
                                try {
                                    let obj = JSON.parse(content);
                                    // 兼容 '直接回复8' 和 '直接回复 8'
                                    if (obj.event === 'node_finished' && obj.data && obj.data.title && (obj.data.title === '直接回复8' || obj.data.title === '直接回复 8')) {
                                        if (obj.data.outputs && obj.data.outputs.answer) {
                                            result = obj.data.outputs.answer;
                                            document.getElementById('stream_result').innerText = result;
                                        }
                                    }
                                } catch (e) {
                                    // 忽略解析失败的片段
                                }
                            }
                        }
                    }
                }
            } catch (err) {
                showError('系统异常: ' + err);
            }
        }
    </script>
</head>
<body>
<div class="container">
    <h2>智能文件撰写系统</h2>
    <div id="error_box" class="error"></div>
    <form id="write_form" method="post" action="/upload" enctype="multipart/form-data" onsubmit="handleFormSubmit(event)">
        <div class="form-flex">
            <div class="form-section">
                <div class="form-group">
                    <label for="sys_query">公文类型（必填）</label>
                    <select id="sys_query" name="sys_query" required>
                        <option value="">请选择</option>
                        <option value="工作报告">工作报告</option>
                        <option value="领导讲话">领导讲话</option>
                        <option value="工作要点">工作要点</option>
                        <option value="处室总结">处室总结</option>
                        <option value="表态发言">表态发言</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="query">主题（必填）</label>
                    <input type="text" id="query" name="query" maxlength="100" required placeholder="请写一篇关于……的文章">
                </div>
                <div class="form-group">
                    <label for="if_rewriter">是否改写（必填）</label>
                    <select id="if_rewriter" name="if_rewriter" required onchange="updateFormDisplay()">
                        <option value="">请选择</option>
                        <option value="是">是</option>
                        <option value="否">否</option>
                    </select>
                </div>
                <div class="form-group" id="origin_article_group" style="display:none;">
                    <label for="origin_article">原文（如改写，需上传）</label>
                    <input type="file" id="origin_article" name="origin_article" accept=".pdf,.doc,.docx,.txt,.md,.markdown,.html,.xls,.xlsx,.ppt,.pptx,.xml,.epub,.csv,.eml,.msg">
                </div>
                <div class="form-group">
                    <label for="if_imitate_writing">是否仿写（必填）</label>
                    <select id="if_imitate_writing" name="if_imitate_writing" required onchange="updateFormDisplay()">
                        <option value="">请选择</option>
                        <option value="是">是</option>
                        <option value="否">否</option>
                    </select>
                </div>
                <div class="form-group" id="imitate_article_group" style="display:none;">
                    <label for="imitate_article">仿写的文章（如仿写，需上传）</label>
                    <input type="file" id="imitate_article" name="imitate_article" accept=".pdf,.doc,.docx,.txt,.md,.markdown,.html,.xls,.xlsx,.ppt,.pptx,.xml,.epub,.csv,.eml,.msg">
                </div>
                <div class="form-group">
                    <label for="Superior_docs">上级文件（可选）</label>
                    <input type="file" id="Superior_docs" name="Superior_docs" accept=".pdf,.doc,.docx,.txt,.md,.markdown,.html,.xls,.xlsx,.ppt,.pptx,.xml,.epub,.csv,.eml,.msg,.jpg,.jpeg,.png,.gif,.webp,.svg">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="if_database">是否查数据库（必填）</label>
                    <select id="if_database" name="if_database" required onchange="updateFormDisplay()">
                        <option value="">请选择</option>
                        <option value="是">是</option>
                        <option value="否">否</option>
                    </select>
                </div>
                <div class="form-group" id="keyword_database_group" style="display:none;">
                    <label for="keyword_database">查询关键词（如查数据库必填）</label>
                    <input type="text" id="keyword_database" name="keyword_database" maxlength="48" placeholder="如：年份、政务服务、法治建设等">
                </div>
                <div class="form-group">
                    <label for="if_online_search">是否联网搜索（必填）</label>
                    <select id="if_online_search" name="if_online_search" required onchange="updateFormDisplay()">
                        <option value="">请选择</option>
                        <option value="是">是</option>
                        <option value="否">否</option>
                    </select>
                </div>
                <div class="form-group" id="online_search_topic_group" style="display:none;">
                    <label for="online_search_topic">联网搜索的主题（如网搜，需填写）</label>
                    <input type="text" id="online_search_topic" name="online_search_topic" maxlength="48" placeholder="请输入联网搜索主题">
                </div>
            </div>
        </div>
        <button type="submit">提交生成</button>
    </form>
    <div class="stream-result" id="stream_result"></div>
</div>
<script>updateFormDisplay();</script>
</body>
</html> 